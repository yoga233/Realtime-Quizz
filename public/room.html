<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ruang Kuis</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    * { font-family: 'Inter', sans-serif; }
    
    .chat-container::-webkit-scrollbar {
      width: 6px;
    }
    .chat-container::-webkit-scrollbar-track {
      background: #f3f4f6;
      border-radius: 10px;
    }
    .chat-container::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 10px;
    }
    .chat-container::-webkit-scrollbar-thumb:hover {
      background: #9ca3af;
    }

    .option-btn {
      transition: all 0.2s ease;
    }
    
    .option-btn:hover:not(:disabled) {
      border-color: #111827;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
  </style>
</head>

<body class="bg-gray-50 min-h-screen">
  <div class="container mx-auto p-6 max-w-6xl">

    <!-- Header -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
      <div class="flex justify-between items-start mb-4">
        <div>
          <h1 class="text-3xl font-bold text-gray-900">Ruang Kuis</h1>
          <p class="text-xl text-gray-600 mt-1">Kode Ruangan: <span id="roomCodeDisplay" class="font-mono font-bold text-gray-900">---</span></p>
        </div>
        <div class="text-right">
          <p class="text-sm text-gray-600">Kutebak kamu pasti</p>
          <p class="font-semibold text-gray-900" id="usernameDisplay">---</p>
        </div>
      </div>
      <p id="connectionStatus" class="text-xs text-gray-600">üîå Connecting...</p>
    </div>

    <!-- Main Layout -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

      <!-- Left Sidebar: Players & Chat -->
      <div class="lg:col-span-1 space-y-6">

        <!-- Players List -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
          <h2 class="text-lg font-bold text-gray-900 mb-4 flex items-center justify-between">
            <span>Pemain</span>
            <span id="playerCount" class="bg-gray-900 text-white text-xs font-bold px-3 py-1 rounded-full">0</span>
          </h2>
          <div id="playerList" class="space-y-2">
            <p class="text-sm text-gray-500">Memuat pemain...</p>
          </div>
        </div>

        <!-- Chat -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 flex flex-col h-96">
          <h2 class="text-lg font-bold text-gray-900 mb-4">Obrolan</h2>
          <div id="chatMessages" class="chat-container flex-1 overflow-y-auto mb-4 bg-gray-50 rounded-lg p-3 space-y-2">
            <p class="text-sm text-gray-500 text-center">Belum ada pesan...</p>
          </div>
          <div class="flex gap-2">
            <input type="text" id="chatInput" placeholder="Ketik pesan..." maxlength="200"
              class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900/10" />
            <button id="sendChatBtn"
              class="px-4 py-2 bg-gray-900 text-white text-sm font-semibold rounded-lg hover:bg-black transition-colors">
              Kirim
            </button>
          </div>
        </div>

      </div>

      <!-- Right Content: Quiz Area -->
      <div class="lg:col-span-2 space-y-6">

        <!-- Waiting State -->
        <div id="waitingState" class="bg-white rounded-xl shadow-sm border border-gray-200 p-12 text-center">
          <div class="text-6xl mb-4">‚è≥</div>
          <h2 class="text-2xl font-bold text-gray-900 mb-2">Menunggu Kuis dimulai</h2>
          <p class="text-gray-600 mb-8">Host akan segera memulai.</p>

          <!-- Host Controls -->
          <div id="hostControls" class="hidden space-y-4">
            <div class="flex gap-3 justify-center mb-6">
              <button id="createQuestionBtn"
                class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors">
                + Buat Pertanyaan
              </button>
              <button id="startQuizBtn"
                class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition-colors">
                Mulai Kuis
              </button>
            </div>
            <div id="questionList" class="max-h-64 overflow-y-auto"></div>
          </div>

          <!-- Player Waiting -->
          <div id="playerWaiting" class="hidden">
            <p class="text-gray-600">Menunggu host untuk memulai...</p>
          </div>
        </div>

        <!-- Quiz State -->
        <div id="quizState" class="hidden bg-white rounded-xl shadow-sm border border-gray-200 p-8">
          <div class="flex justify-between items-center mb-6 pb-6 border-b border-gray-200">
            <div>
              <p class="text-sm text-gray-600">Pertanyaan</p>
              <p class="text-2xl font-bold text-gray-900"><span id="questionNumber">1</span> / <span id="totalQuestions">5</span></p>
            </div>
            <div class="text-right">
              <p class="text-sm text-gray-600">Waktu Tersisa</p>
              <p id="timer" class="text-4xl font-bold text-red-600">15</p>
            </div>
          </div>

          <h3 id="questionText" class="text-xl font-bold text-gray-900 mb-6">Memuat pertanyaan...</h3>

          <div id="optionsContainer" class="space-y-3 mb-6">
            <!-- Options rendered here -->
          </div>

          <div id="answerStatus" class="hidden p-4 rounded-lg"></div>
        </div>

        <!-- Finished State -->
        <div id="finishedState" class="hidden bg-white rounded-xl shadow-sm border border-gray-200 p-8 text-center">
          <div class="text-6xl mb-4">üèÜ</div>
          <h2 class="text-3xl font-bold text-gray-900 mb-2">Kuis berakhir!</h2>
          <p class="text-gray-600 mb-8">Makasih sudah berpartisipasi</p>

          <div class="mb-8">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Papan Skor Akhir</h3>
            <div id="finalLeaderboard" class="space-y-2"></div>
          </div>

            <button id="viewReviewBtn"
            class="px-6 py-3 bg-gray-900 text-white font-semibold rounded-lg hover:bg-black transition-colors">
            Lihat Hasil
          </button>
        </div>

        <!-- Review State -->
        <div id="reviewState" class="hidden bg-white rounded-xl shadow-sm border border-gray-200 p-8">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-900">Hasilmu</h2>
            <button id="backToLeaderboardBtn" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
              ‚Üê Kembali
            </button>
          </div>

          <div class="grid grid-cols-3 gap-4 mb-8 p-4 bg-gray-50 rounded-lg">
            <div class="text-center">
              <p class="text-sm text-gray-600">Skor</p>
              <p id="reviewScore" class="text-3xl font-bold text-gray-900">0</p>
            </div>
            <div class="text-center">
              <p class="text-sm text-gray-600">Benar</p>
              <p id="reviewCorrect" class="text-3xl font-bold text-green-600">0</p>
            </div>
            <div class="text-center">
              <p class="text-sm text-gray-600">Salah</p>
              <p id="reviewWrong" class="text-3xl font-bold text-red-600">0</p>
            </div>
          </div>

          <div id="reviewQuestions" class="space-y-4"></div>
        </div>

        <!-- Leaderboard -->
        <div id="realtimeLeaderboard" class="hidden bg-white rounded-xl shadow-sm border border-gray-200 p-6">
          <h3 class="text-lg font-bold text-gray-900 mb-4">Papan Skor</h3>
          <div id="leaderboardList" class="space-y-2"></div>
        </div>

      </div>

    </div>

    <!-- Leave Button -->
      <div class="text-center mt-8">
      <button id="leaveRoomBtn" class="text-red-600 hover:text-red-800 text-sm font-medium">
        ‚Üê Keluar Ruangan
      </button>
    </div>

  </div>

  <!-- Question Modal -->
  <div id="questionModal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-8 w-full max-w-lg mx-4 max-h-96 overflow-y-auto">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">Buat Pertanyaan</h2>

      <form id="questionForm" class="space-y-4">
        <div>
          <label class="block text-sm font-semibold text-gray-900 mb-2">Pertanyaan</label>
          <textarea id="modalQuestionText" rows="3" placeholder="Masukkan pertanyaan..."
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900/10"
            required></textarea>
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-900 mb-2">Pilihan</label>
          <div class="space-y-2">
            <input type="text" id="modalOptionA" placeholder="Pilihan A" 
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900/10" required>
            <input type="text" id="modalOptionB" placeholder="Pilihan B" 
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900/10" required>
            <input type="text" id="modalOptionC" placeholder="Pilihan C" 
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900/10" required>
            <input type="text" id="modalOptionD" placeholder="Pilihan D" 
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900/10" required>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold text-gray-900 mb-2">Jawaban Benar</label>
            <select id="modalCorrectAnswer" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900/10" required>
              <option value="">Pilih...</option>
              <option value="0">A</option>
              <option value="1">B</option>
              <option value="2">C</option>
              <option value="3">D</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-900 mb-2">Waktu (detik)</label>
            <input type="number" id="modalTimerValue" min="10" max="300" value="15" 
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900/10" required>
          </div>
        </div>

        <div class="flex gap-3 pt-4">
          <button type="button" id="cancelQuestionBtn" 
            class="flex-1 px-4 py-2 border border-gray-300 text-gray-900 rounded-lg hover:bg-gray-50">
            Batal
          </button>
          <button type="submit" 
            class="flex-1 px-4 py-2 bg-gray-900 text-white rounded-lg hover:bg-black">
            Tambah Pertanyaan
          </button>
        </div>
      </form>
    </div>
  </div>

  <script src="/js/ws-client.js"></script>

  <script>
    let ws = null;
    let clientId = null;
    let username = null;
    let roomCode = null;
    let isHost = false;
    let isConnected = false;
    let currentQuizState = 'waiting';
    let currentQuestion = null;
    let questionStartTime = null;
    let timerInterval = null;
    let hasAnswered = false;
    let manualReviewOpen = false;
    let players = [];
    let chatMessages = [];
    let myReviewData = null;
    let customQuestions = [];

    function escapeHtml(text = '') {
      const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
      return String(text).replace(/[&<>"']/g, m => map[m]);
    }

    function byId(id) { return document.getElementById(id); }

    function init() {
      username = localStorage.getItem('username');
      roomCode = localStorage.getItem('currentRoomCode');
      isHost = localStorage.getItem('isHost') === 'true';
      clientId = localStorage.getItem('clientId');

      if (!username || !roomCode) {
        alert('Data hilang! Mengalihkan...');
        window.location.href = '/lobby.html';
        return;
      }

      byId('usernameDisplay').textContent = username;
      byId('roomCodeDisplay').textContent = roomCode;

      if (isHost) {
        byId('hostControls').classList.remove('hidden');
        byId('playerWaiting').classList.add('hidden');
      } else {
        byId('hostControls').classList.add('hidden');
        byId('playerWaiting').classList.remove('hidden');
      }

      initWebSocket();
    }

    function initWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const host = window.location.host;
      const wsUrl = `${protocol}//${host}`;

      console.log("Connecting to:", wsUrl);
      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        console.log('‚úÖ WebSocket connected');
        isConnected = true;
        byId('connectionStatus').innerHTML = '‚úÖ <span class="text-green-600 font-medium">Connected</span>';
        setTimeout(() => sendMessage('get-room-data', { roomCode, username }), 500);
      };

      ws.onmessage = (event) => {
        try {
          const { type, data } = JSON.parse(event.data);
          console.log('üì© Received:', type);
          handleMessage(type, data);
        } catch (error) {
          console.error('Error parsing message:', error);
        }
      };

      ws.onclose = () => {
        console.log('‚ùå WebSocket disconnected');
        isConnected = false;
        byId('connectionStatus').innerHTML = '‚ùå <span class="text-red-600 font-medium">Disconnected</span>';
        setTimeout(() => initWebSocket(), 3000);
      };
    }

    function handleMessage(type, data) {
      switch (type) {
        case 'connected':
          clientId = data.clientId;
          localStorage.setItem('clientId', clientId);
          break;

        case 'room-data':
          players = data.room.players || [];
          chatMessages = data.room.chat || [];
          updatePlayerList();
          updateChatMessages();
          isHost = data.isHost;
          localStorage.setItem('isHost', isHost ? 'true' : 'false');
          if (isHost) {
            byId('hostControls').classList.remove('hidden');
            byId('playerWaiting').classList.add('hidden');
          }
          if (data.room.quiz && data.room.quiz.status === 'playing' && !manualReviewOpen) {
            switchState('quiz');
            byId('realtimeLeaderboard').classList.remove('hidden');
          }
          break;

        case 'player-joined':
          players = data.players || [];
          updatePlayerList();
          addSystemMessage(`${data.username} joined`);
          break;

        case 'player-left':
          players = data.players || [];
          updatePlayerList();
          break;

        case 'new-chat':
          addChatMessage(data.username, data.message, data.timestamp);
          break;

        case 'quiz-started':
          addSystemMessage('Quiz started!');
          setTimeout(() => switchState('quiz'), 800);
          break;

        case 'new-question':
          if (!manualReviewOpen) displayQuestion(data);
          break;

        case 'answer-submitted':
          showAnswerResult(data);
          break;

        case 'leaderboard-update':
          updateLeaderboard(data.leaderboard || []);
          break;

        case 'quiz-finished':
          displayFinalLeaderboard(data.leaderboard || []);
          if (!manualReviewOpen) switchState('finished');
          break;

        case 'player-review':
          manualReviewOpen = true;
          displayReview(data);
          break;
      }
    }

    function sendMessage(type, data = {}) {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type, data }));
      }
    }

    function switchState(state) {
      const states = ['waitingState', 'quizState', 'finishedState', 'reviewState'];
      states.forEach(s => byId(s).classList.add('hidden'));
      if (state === 'waiting') byId('waitingState').classList.remove('hidden');
      if (state === 'quiz') byId('quizState').classList.remove('hidden');
      if (state === 'finished') byId('finishedState').classList.remove('hidden');
      if (state === 'review') byId('reviewState').classList.remove('hidden');
      currentQuizState = state;
    }

    function updatePlayerList() {
      const container = byId('playerList');
      byId('playerCount').textContent = players.length;
      if (!players || players.length === 0) {
        container.innerHTML = '<p class="text-sm text-gray-500">No players yet...</p>';
        return;
      }
      container.innerHTML = players.map((p, i) => `
        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
          <div><p class="font-semibold text-gray-900">${escapeHtml(p.username)}</p></div>
          <div class="text-right"><p class="font-bold text-gray-900">${p.score ?? 0}</p></div>
        </div>
      `).join('');
    }

    function updateChatMessages() {
      const container = byId('chatMessages');
      if (!chatMessages || chatMessages.length === 0) {
        container.innerHTML = '<p class="text-sm text-gray-500 text-center">No messages yet...</p>';
        return;
      }
      container.innerHTML = chatMessages.map(msg => {
        const time = new Date(msg.timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        return `
          <div class="bg-white rounded p-2"><p class="text-xs text-gray-600 mb-1"><strong>${escapeHtml(msg.username)}</strong> ${time}</p>
          <p class="text-sm text-gray-800">${escapeHtml(msg.message)}</p></div>
        `;
      }).join('');
      container.scrollTop = container.scrollHeight;
    }

    function addChatMessage(username, message, timestamp = Date.now()) {
      chatMessages.push({ username, message, timestamp });
      updateChatMessages();
    }

    function addSystemMessage(message) {
      const container = byId('chatMessages');
      container.innerHTML += `<div class="bg-blue-50 rounded p-2 border-l-4 border-blue-500">
        <p class="text-xs text-blue-700 font-semibold">${escapeHtml(message)}</p></div>`;
      container.scrollTop = container.scrollHeight;
    }

    function displayQuestion(data) {
      if (currentQuizState === 'review') return;
      currentQuestion = data;
      hasAnswered = false;
      questionStartTime = data.startTime || Date.now();

      byId('questionNumber').textContent = data.questionNumber ?? 1;
      byId('totalQuestions').textContent = data.totalQuestions ?? 1;
      byId('questionText').textContent = data.question ?? '‚Äî';
      byId('answerStatus').classList.add('hidden');

      const optionsContainer = byId('optionsContainer');
      optionsContainer.innerHTML = (data.options || []).map((option, index) => `
        <button class="option-btn w-full text-left p-4 bg-gray-50 hover:bg-white border-2 border-gray-200 rounded-lg transition font-semibold text-gray-900" data-index="${index}">
          <span class="text-lg mr-3">${String.fromCharCode(65 + index)}.</span>
          ${escapeHtml(option)}
        </button>
      `).join('');

      document.querySelectorAll('.option-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          if (!hasAnswered) submitAnswer(parseInt(btn.dataset.index));
        });
      });

      let remaining = data.timer ?? 15;
      if (data.startTime) {
        const elapsed = Math.floor((Date.now() - data.startTime) / 1000);
        remaining = Math.max(0, (data.timer || 15) - elapsed);
      }
      startTimer(remaining);
      switchState('quiz');
    }

    function startTimer(seconds) {
      let timeLeft = Math.max(0, parseInt(seconds, 10) || 0);
      const timerElement = byId('timer');

      if (timerInterval) clearInterval(timerInterval);

      timerElement.textContent = timeLeft;
      timerElement.className = 'text-4xl font-bold text-green-600';

      timerInterval = setInterval(() => {
        timeLeft--;
        if (timeLeft < 0) timeLeft = 0;
        timerElement.textContent = timeLeft;

        if (timeLeft <= 5) {
          timerElement.className = 'text-4xl font-bold text-red-600 animate-pulse';
        } else if (timeLeft <= 10) {
          timerElement.className = 'text-4xl font-bold text-yellow-600';
        }

        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          if (!hasAnswered) {
            document.querySelectorAll('.option-btn').forEach(btn => {
              btn.disabled = true;
              btn.classList.add('opacity-50');
            });
          }
        }
      }, 1000);
    }

    function submitAnswer(answerIndex) {
      if (hasAnswered || !currentQuestion) return;
      hasAnswered = true;

      const timeToAnswer = parseFloat(((Date.now() - questionStartTime) / 1000).toFixed(1));
      document.querySelectorAll('.option-btn').forEach(btn => {
        btn.disabled = true;
        btn.classList.add('opacity-50');
      });

      sendMessage('submit-answer', { roomCode, answerIndex, timeToAnswer });
    }

    function showAnswerResult(data) {
      const statusDiv = byId('answerStatus');
      document.querySelectorAll('.option-btn').forEach(btn => {
        const index = parseInt(btn.dataset.index, 10);
        if (index === data.correctAnswer) {
          btn.classList.add('ring-2', 'ring-green-500', 'bg-green-50');
        }
      });

      if (data.isCorrect) {
        statusDiv.innerHTML = `<div class="bg-green-50 border-2 border-green-200 text-green-900 p-4 rounded-lg text-center">
          <p class="font-bold text-lg">‚úÖ Benar!</p><p class="text-sm">+${data.points} poin</p></div>`;
      } else {
        statusDiv.innerHTML = `<div class="bg-red-50 border-2 border-red-200 text-red-900 p-4 rounded-lg text-center">
          <p class="font-bold text-lg">‚ùå Salah</p><p class="text-sm">Jawaban benar: <strong>${escapeHtml(data.correctAnswerText || '')}</strong></p></div>`;
      }
      statusDiv.classList.remove('hidden');
      if (timerInterval) clearInterval(timerInterval);
    }

    function updateLeaderboard(leaderboard) {
      const container = byId('leaderboardList');
      container.innerHTML = (leaderboard || []).map((p, i) => `
        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
          <div><p class="font-semibold text-gray-900">${escapeHtml(p.username)}</p></div>
          <div class="text-right"><p class="font-bold text-lg text-gray-900">${p.score ?? 0}</p></div>
        </div>
      `).join('');
    }

    function displayFinalLeaderboard(leaderboard) {
      const container = byId('finalLeaderboard');
      container.innerHTML = (leaderboard || []).map((p, i) => `
        <div class="flex items-center justify-between p-4 ${p.username === username ? 'bg-blue-50 border-2 border-blue-300' : 'bg-gray-50'} rounded-lg">
          <div><p class="font-bold text-gray-900">${i + 1}. ${escapeHtml(p.username)} ${p.username === username ? '(You)' : ''}</p></div>
          <div class="text-right"><p class="font-bold text-lg text-gray-900">${p.score ?? 0}</p></div>
        </div>
      `).join('');
    }

    function displayReview(data) {
      myReviewData = data;
      byId('reviewScore').textContent = data.score ?? 0;
      byId('reviewCorrect').textContent = data.totalCorrect ?? 0;
      byId('reviewWrong').textContent = (data.totalQuestions ?? 0) - (data.totalCorrect ?? 0);

      const container = byId('reviewQuestions');
      container.innerHTML = (data.answers || []).map((a, i) => {
        const isCorrect = a.isCorrect;
        return `
          <div class="${isCorrect ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'} border-2 rounded-lg p-4">
            <p class="font-bold text-gray-900 mb-2">${isCorrect ? '‚úÖ' : '‚ùå'} Question ${i + 1}</p>
            <p class="text-gray-800 mb-3">${escapeHtml(a.question)}</p>
            <div class="space-y-2">
              ${(a.options || []).map((opt, j) => {
                let cls = 'bg-white border-gray-300';
                if (j === a.correctAnswer) cls = 'bg-green-100 border-green-500';
                if (j === a.selectedAnswer && !isCorrect) cls = 'bg-red-100 border-red-500';
                return `<div class="border-2 ${cls} rounded p-2"><span class="font-semibold">${String.fromCharCode(65 + j)}.</span> ${escapeHtml(opt)}</div>`;
              }).join('')}
            </div>
            <p class="text-sm mt-3 font-semibold ${isCorrect ? 'text-green-700' : 'text-red-700'}">${isCorrect ? '+' + a.pointsEarned : '0'} pts (${a.timeToAnswer}s)</p>
          </div>
        `;
      }).join('');
      switchState('review');
    }

    function showQuestionModal() {
      byId('questionModal').classList.remove('hidden');
    }

    function hideQuestionModal() {
      byId('questionModal').classList.add('hidden');
    }

    function saveQuestion(e) {
      e.preventDefault();
      const question = byId('modalQuestionText').value.trim();
      const options = [byId('modalOptionA').value.trim(), byId('modalOptionB').value.trim(), byId('modalOptionC').value.trim(), byId('modalOptionD').value.trim()];
      const correctIndex = parseInt(byId('modalCorrectAnswer').value);
      const timer = parseInt(byId('modalTimerValue').value);

      if (!question || options.some(o => !o) || isNaN(correctIndex) || timer < 10) {
        alert('Please fill all fields');
        return;
      }

      customQuestions.push({ question, options, correct: correctIndex, timer });
      updateQuestionList();
      hideQuestionModal();
    }

    function updateQuestionList() {
      const container = byId('questionList');
      if (customQuestions.length === 0) {
        container.innerHTML = '<p class="text-gray-600 text-sm">No questions yet</p>';
        return;
      }
      container.innerHTML = customQuestions.map((q, i) => `
        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-2">
          <div class="flex justify-between">
            <div class="flex-1"><p class="font-bold text-gray-900">Q${i + 1} (${q.timer}s)</p>
            <p class="text-sm text-gray-700">${escapeHtml(q.question)}</p></div>
            <button onclick="removeQuestion(${i})" class="text-red-600 hover:text-red-800">‚úï</button>
          </div>
        </div>
      `).join('');
    }

    function removeQuestion(index) {
      customQuestions.splice(index, 1);
      updateQuestionList();
    }

    function attachUiListeners() {
      byId('sendChatBtn').addEventListener('click', () => {
        const msg = byId('chatInput').value.trim();
        if (msg) {
          sendMessage('send-chat', { roomCode, message: msg });
          byId('chatInput').value = '';
        }
      });

      byId('chatInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') byId('sendChatBtn').click();
      });

      byId('createQuestionBtn')?.addEventListener('click', showQuestionModal);
      byId('cancelQuestionBtn')?.addEventListener('click', hideQuestionModal);
      byId('questionForm')?.addEventListener('submit', saveQuestion);

      byId('startQuizBtn')?.addEventListener('click', () => {
        if (customQuestions.length === 0) {
          alert('Create at least 1 question');
          return;
        }
        sendMessage('start-quiz', { roomCode, questions: customQuestions });
      });

      byId('viewReviewBtn')?.addEventListener('click', () => {
        manualReviewOpen = true;
        sendMessage('get-my-review', { roomCode });
      });

      byId('backToLeaderboardBtn')?.addEventListener('click', () => {
        manualReviewOpen = false;
        switchState('finished');
      });

      byId('leaveRoomBtn').addEventListener('click', () => {
        if (confirm('Leave room?')) {
          localStorage.removeItem('currentRoomCode');
          localStorage.removeItem('isHost');
          window.location.href = '/lobby.html';
        }
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      init();
      attachUiListeners();
      setInterval(() => {
        if (!manualReviewOpen && ws && ws.readyState === WebSocket.OPEN) {
          sendMessage('get-room-data', { roomCode, username });
        }
      }, 5000);
    });
  </script>

</body>

</html>
